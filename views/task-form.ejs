<!--
task-form.ejs

新建/编辑任务页面，包含表单、LLM和群聊选择、时间配置等。
引用task-form.js和task-form.css。
-->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title><%= mode === 'edit' ? '编辑任务' : '创建任务' %> - 微信群聊智能分析平台</title>
    <link rel="stylesheet" href="/css/style.css?v=5.6">
    <link rel="stylesheet" href="/css/task-form.css?v=5.6">
</head>
<body>
    <nav class="main-nav">
        <div class="nav-container">
            <div class="nav-brand">
                <h2>微信群聊智能分析平台</h2>
            </div>
            <ul class="nav-menu">
                <li><a href="/tasks" class="nav-link active">任务管理</a></li>
                <li><a href="/reports" class="nav-link">报告中心</a></li>
                <li><a href="/prompt-templates" class="nav-link">提示词管理</a></li>
                <li><a href="/settings" class="nav-link">系统设置</a></li>
            </ul>
            <div class="nav-actions">
                <button class="theme-toggle" aria-label="切换主题">🌙</button>
            </div>
        </div>
    </nav>
    
    <div class="page-container">
        <div class="page-content">
            <div class="content-header">
                <h2><%= mode === 'edit' ? '📝 编辑任务' : '➕ 创建任务' %></h2>
                <div class="content-stats">
                    <span class="stat-item">步骤：<strong>1/6</strong></span>
                </div>
            </div>
            
            <div class="content-main">
                <form id="task-form">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">📝 基础信息</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="name" class="form-label required">任务名称</label>
                                <input type="text" id="name" name="name" class="form-control" required maxlength="32" placeholder="请输入任务名称">
                                <div class="form-text">为任务起一个便于识别的名称</div>
                            </div>
                        </div>
                    </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">📱 群聊选择</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label required">分析群聊</label>
                            
                            <!-- 搜索框 -->
                            <div class="chatroom-search-container">
                                <input type="text" id="chatroomSearch" class="form-control" 
                                       placeholder="🔍 搜索群聊名称...">
                                <button type="button" id="refreshChatrooms" class="btn btn-secondary btn-sm" title="刷新群聊列表">
                                    <span>🔄</span> 刷新
                                </button>
                            </div>
                            
                            <!-- 群聊列表容器 -->
                            <div class="chatroom-list-container">
                                <div id="chatroomLoadingIndicator" class="loading">
                                    正在加载群聊列表...
                                </div>
                                
                                <div id="chatroomList" class="chatroom-list" style="display: none;">
                                    <!-- 动态填充群聊选项 -->
                                </div>
                                
                                <div id="chatroomEmptyState" class="empty-state" style="display: none;">
                                    <div class="empty-icon">📭</div>
                                    <h3>暂无可用的群聊</h3>
                                    <p>请检查ChatLog服务是否正常运行</p>
                                </div>
                            </div>
                            
                            <!-- 已选择统计 -->
                            <div class="selected-summary" id="selectedChatroomsSummary" style="display: none;">
                                <span class="badge badge-success">✅ 已选择 <span id="selectedChatroomsCount">0</span> 个群聊</span>
                                <button type="button" id="clearAllChatrooms" class="btn btn-secondary btn-sm">全部清除</button>
                            </div>
                            
                            <div class="form-text">点击群聊名称进行多选，支持搜索快速定位</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">⏰ 定时配置</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label required">定时执行配置</label>
                            
                            <!-- 执行类型选择 -->
                            <div class="schedule-type-selector">
                                <label class="schedule-option">
                                    <input type="radio" name="scheduleType" value="once" checked>
                                    <span class="option-label">📅 单次执行</span>
                                    <div class="form-text">指定具体日期时间执行一次</div>
                                </label>
                                
                                <label class="schedule-option">
                                    <input type="radio" name="scheduleType" value="daily">
                                    <span class="option-label">🕐 每天执行</span>
                                    <div class="form-text">每天在指定时间自动执行</div>
                                </label>
                                
                                <label class="schedule-option">
                                    <input type="radio" name="scheduleType" value="weekly">
                                    <span class="option-label">📆 每周执行</span>
                                    <div class="form-text">每周在指定日期和时间执行</div>
                                </label>
                            </div>
                            
                            <!-- 单次执行配置 -->
                            <div id="onceScheduleConfig" class="schedule-config">
                                <label for="scheduleTime" class="form-label">执行时间</label>
                                <input type="datetime-local" id="scheduleTime" name="scheduleTime" class="form-control">
                                <div class="form-text">请选择任务的执行日期和时间</div>
                            </div>
                            
                            <!-- 每天执行配置 -->
                            <div id="dailyScheduleConfig" class="schedule-config" style="display: none;">
                                <label for="dailyTime" class="form-label">每天执行时间</label>
                                <input type="time" id="dailyTime" name="dailyTime" class="form-control" value="09:00">
                                <div class="form-text">任务将在每天的此时间自动执行</div>
                            </div>
                            
                            <!-- 每周执行配置 -->
                            <div id="weeklyScheduleConfig" class="schedule-config" style="display: none;">
                                <div class="weekday-time-container">
                                    <div class="weekday-section">
                                        <label class="form-label">执行星期</label>
                                        <div class="weekday-selector">
                                            <label class="weekday-option">
                                                <input type="checkbox" name="weeklyDays" value="1"> 周一
                                            </label>
                                            <label class="weekday-option">
                                                <input type="checkbox" name="weeklyDays" value="2"> 周二
                                            </label>
                                            <label class="weekday-option">
                                                <input type="checkbox" name="weeklyDays" value="3"> 周三
                                            </label>
                                            <label class="weekday-option">
                                                <input type="checkbox" name="weeklyDays" value="4"> 周四
                                            </label>
                                            <label class="weekday-option">
                                                <input type="checkbox" name="weeklyDays" value="5"> 周五
                                            </label>
                                            <label class="weekday-option">
                                                <input type="checkbox" name="weeklyDays" value="6"> 周六
                                            </label>
                                            <label class="weekday-option">
                                                <input type="checkbox" name="weeklyDays" value="0"> 周日
                                            </label>
                                        </div>
                                    </div>
                                    <div class="time-section">
                                        <label for="weeklyTime" class="form-label">执行时间</label>
                                        <input type="time" id="weeklyTime" name="weeklyTime" class="form-control" value="09:00">
                                    </div>
                                </div>
                                <div class="form-text">选择一周中的哪些天执行任务</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">📊 分析配置</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="timeRange" class="form-label required">分析时间范围</label>
                            <select id="timeRange" name="timeRange" class="form-control" required>
                                <option value="recent_1d">最近1天</option>
                                <option value="recent_3d">最近3天</option>
                                <option value="recent_7d" selected>最近7天</option>
                                <option value="recent_15d">最近15天</option>
                                <option value="recent_30d">最近30天</option>
                                <option value="custom">自定义时间范围</option>
                                <option value="all">所有时间</option>
                            </select>
                            <div class="form-text">选择要分析的聊天记录时间范围</div>
                        </div>
                        
                        <div class="form-group custom-time-range" id="customTimeRange" style="display: none;">
                            <label class="form-label">自定义时间范围</label>
                            <div class="date-range-container">
                                <input type="date" id="startDate" name="startDate" class="form-control" placeholder="开始日期">
                                <span class="date-separator">至</span>
                                <input type="date" id="endDate" name="endDate" class="form-control" placeholder="结束日期">
                            </div>
                            <div class="form-text">自定义分析的起止时间</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="llmModel" class="form-label required">LLM模型</label>
                            <select id="llmModel" name="llmModel" class="form-control" required>
                                <option value="">请选择模型</option>
                                
                                <optgroup label="DeepSeek">
                                    <option value="deepseek-chat">DeepSeek Chat (通用模型)</option>
                                    <option value="deepseek-reasoner">DeepSeek Reasoner (推荐，推理模型)</option>
                                </optgroup>
                                
                                <optgroup label="Gemini">
                                    <option value="gemini-2.5-pro">Gemini 2.5 Pro (推荐，最新模型)</option>
                                    <option value="gemini-2.0-flash">Gemini 2.0 Flash (快速版本)</option>
                                </optgroup>
                                
                                <optgroup label="Kimi">
                                    <option value="kimi-k2-0711-preview">Kimi K2 (最新版本)</option>
                                </optgroup>
                            </select>
                            <div class="form-text">选择合适的模型版本，推理类任务推荐 DeepSeek R1，通用分析推荐 DeepSeek V3</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="promptTemplate" class="form-label required">系统提示词模板</label>
                            <select id="promptTemplate" name="promptTemplate" class="form-control" required>
                                <option value="">请选择分析模板</option>
                                <!-- 模板选项由JS动态加载 -->
                            </select>
                            <div class="form-text">选择预设的分析场景模板</div>
                            
                            <!-- 模板操作区域 -->
                            <div class="template-actions-row" id="templateActions">
                                <div class="template-description">
                                    <span id="templateDescription">请选择模板查看描述</span>
                                </div>
                                <button type="button" class="template-preview-btn" onclick="showTemplateModal()">
                                    查看完整提示词内容
                                </button>
                                <div id="templateSystemPrompt" style="display: none;">暂无模板内容</div>
                            </div>
                        </div>
                    </div>
                </div>

                    <div class="form-actions">
                        <button type="submit" id="saveBtn" class="btn btn-primary btn-lg">
                            <span><%= mode === 'edit' ? '💾' : '➕' %></span> <%= mode === 'edit' ? '保存修改' : '创建任务' %>
                        </button>
                        <a href="/tasks" class="btn btn-secondary btn-lg">
                            <span>❌</span> 取消
                        </a>
                    </div>
                    
                    <div id="form-feedback" class="feedback"></div>
                </form>
            </div>
        </div>
    </div>

    <!-- 模板预览模态框 -->
    <div id="templateModal" class="template-modal-overlay" style="display: none;">
        <div class="template-modal">
            <div class="template-modal-header">
                <h3 class="template-modal-title">
                    <span>📋</span> 提示词模板预览
                </h3>
            </div>
            <div class="template-modal-body">
                <div id="templateModalContent" class="template-modal-content">
                    <!-- 模板内容将在这里显示 -->
                </div>
            </div>
            <div class="template-modal-footer">
                <button type="button" class="template-modal-close" onclick="hideTemplateModal()">
                    关闭
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // 页面模式与任务ID，供JS使用
        window.TASK_FORM_MODE = '<%= mode %>';
        window.TASK_ID = <%- typeof taskId !== 'undefined' ? JSON.stringify(taskId) : 'null' %>;
        
        // 模板预览模态框控制函数
        function showTemplateModal() {
            const templateContent = document.getElementById('templateSystemPrompt');
            const modalContent = document.getElementById('templateModalContent');
            const modal = document.getElementById('templateModal');
            
            if (templateContent && modalContent && modal) {
                modalContent.textContent = templateContent.textContent || '暂无模板内容';
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden'; // 防止背景滚动
            }
        }
        
        function hideTemplateModal() {
            const modal = document.getElementById('templateModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = ''; // 恢复滚动
            }
        }
        
        // 点击模态框背景关闭
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('templateModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        hideTemplateModal();
                    }
                });
            }
            
            // ESC键关闭模态框
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    hideTemplateModal();
                }
            });
        });
    </script>
    <script src="/js/theme.js"></script>
    <script src="/js/scroll-to-top.js"></script>
    <script src="/js/ui-manager.js"></script>
    <script src="/js/navigation.js"></script>
    <script src="/js/task-form.js"></script>
</body>
</html> 